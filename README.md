# CellAnalyzer

Настольное приложение на базе Qt6 для автоматического обнаружения и анализа клеток на микроскопических изображениях.

## Возможности

### Обнаружение и Анализ

- **Множественные Алгоритмы Детекции**: Поддержка 6 различных алгоритмов
  - HoughCircles (круглые клетки)
  - ContourBased (произвольные формы)
  - Watershed Segmentation (перекрывающиеся клетки)
  - Morphological Operations (определение по форме)
  - Adaptive Threshold (адаптивная по контрасту)
  - Blob Detection (детекция по ключевым точкам)
- **Интерактивная Настройка Параметров**: Предварительный просмотр в реальном времени с автоматической оптимизацией параметров
- **Умный Выбор Клеток**: Клик для выбора целевых клеток, автоматическая оптимизация параметров на основе выбора
- **Определение Масштабной Линейки**: Автоматически определяет масштабные линейки для расчета измерений в микрометрах

### Статистика и Анализ

- **Комплексная Статистика**: Среднее, медиана, стандартное отклонение, квартили, асимметрия, эксцесс
- **Определение Выбросов**: Автоматическое обнаружение аномалий методами IQR и Z-Score
- **Анализ Распределения**: Построение гистограмм и анализ формы распределения
- **Корреляционный Анализ**: Анализ взаимосвязей параметров (Пирсон и Спирмен)
- **Статистика по Изображениям**: Групповая статистика по исходным изображениям
- **Множественные Форматы Экспорта**: Отчеты в формате Text, CSV и Markdown

### Пользовательский Интерфейс

- **Светлая и Темная Темы**: Постоянный выбор темы с пользовательским стилем
- **Масштабируемый Просмотрщик Изображений**: Панорамирование и масштабирование (10%-500%) мышью и элементами управления
- **Поддержка Drag-and-Drop**: Простая загрузка изображений
- **Улучшенная Сетка Предпросмотра**: Множественный выбор, сортировка (имя/дата/размер), изменяемые миниатюры
- **Отслеживание Прогресса**: Детальный диалог прогресса с оценкой времени и возможностью отмены

### Рабочий Процесс

- **Управление Пресетами**: Сохранение/загрузка пресетов параметров с хранением коэффициентов
- **Пакетная Обработка**: Анализ множества изображений с сохраненными пресетами
- **Ручная Проверка**: Проверка и удаление ложных срабатываний перед экспортом
- **Экспорт Данных**: Экспорт CSV с полными измерениями и отдельными изображениями клеток
- **Фильтрация Артефактов**: Фильтрация капель воды и других помех

## Установка

### Требования

- Windows x64
- Visual Studio 2022
- CMake 3.16+
- Qt6
- OpenCV 4.11.0

### Сборка из Исходников

```bash
# Чистая сборка
build-release.bat

# Или вручную:
mkdir build-release
cd build-release
cmake -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release ..
cmake --build . --config Release
```

### Запуск Приложения

```bash
test_run.bat
# Или напрямую:
build\Release\CellAnalyzer.exe
```

## Использование

### Быстрый Старт

1. **Загрузите Изображения**: Нажмите "Добавить изображения" или перетащите микроскопические изображения в окно
2. **Выберите Алгоритм**: Выберите алгоритм детекции (по умолчанию: HoughCircles для круглых клеток)
3. **Настройте Параметры**:
   - Для одного изображения: Кликните на целевые клетки, затем используйте "Подобрать параметры" для автоматической оптимизации
   - Для нескольких изображений: Загрузите сохраненный пресет
4. **Проверьте Результаты**: Просмотрите обнаруженные клетки и удалите ложные срабатывания
5. **Просмотрите Статистику** (опционально): Получите доступ к комплексному статистическому анализу
6. **Экспортируйте Данные**: Сохраните результаты в CSV и экспортируйте отдельные изображения клеток

### Детальные Рабочие Процессы

#### Первоначальная Настройка (Одно Изображение)

1. Загрузите репрезентативное изображение
2. Кликните на несколько целевых клеток (появятся красные точки)
3. Нажмите "Подобрать параметры" для автоматической оптимизации параметров
4. Просмотрите результаты детекции (круги наложены на изображение)
5. Сохраните пресет с осмысленным именем
6. Продолжите к проверке

#### Пакетная Обработка (Множество Изображений)

1. Загрузите множество изображений
2. Выберите сохраненный пресет из выпадающего списка
3. Нажмите кнопку "Анализировать"
4. Дождитесь завершения индикатора прогресса
5. Просмотрите все обнаруженные клетки в сетке проверки
6. Экспортируйте результаты

#### Статистический Анализ

1. Завершите этап проверки
2. Нажмите кнопку "Статистика"
3. Просмотрите вкладки:
   - **Обзор**: Сводная статистика и подсчеты
   - **Детали**: Статистика по изображениям
   - **Распределение**: Гистограммы и форма
   - **Корреляция**: Взаимосвязи параметров
   - **Выбросы**: Обнаружение аномалий
4. Экспортируйте отчеты в желаемом формате (Text/CSV/Markdown)

### Советы

- Используйте переключатель **Светлая/Темная тема** в меню для комфортного просмотра
- **Масштабируйте и панорамируйте** при настройке параметров для точного выбора клеток
- **Перетаскивайте** множество изображений одновременно для ускорения рабочего процесса
- **Сохраняйте пресеты** для разных типов клеток или условий съемки
- Используйте **определение выбросов** для выявления ошибок измерений

## Формат Вывода

### CSV Измерений Клеток

Основной CSV экспорт содержит:

- Имя файла
- Номер клетки
- Координаты центра (X, Y)
- Диаметр в пикселях
- Диаметр в микрометрах (µм)
- Площадь (вычисленная из диаметра)

### Статистические Отчеты

Статистика может быть экспортирована в трех форматах:

**Текстовый Формат**: Читаемый отчет с разделами для:

- Сводная статистика (среднее, медиана, станд. откл. и т.д.)
- Анализ распределения
- Групповая статистика по изображениям
- Информация о выбросах

**CSV Формат**: Данные, совместимые с электронными таблицами:

- Имена и значения параметров
- Статистические метрики в колонках
- Легкий импорт в Excel/R/Python

**Markdown Формат**: Готовый для документации отчет с:

- Отформатированные таблицы
- Заголовки разделов
- Совместимость с системами GitHub/GitLab/документации

### Дополнительные Выходные Данные

- **Изображения Отдельных Клеток**: PNG файлы для каждой обнаруженной клетки
- **Отладочные Изображения**: Аннотированные исходные изображения с наложениями детекции (при включенном логировании)
- **Файлы Логов**: Детальные логи обработки в директории `logs/`

## Технические Детали

### Архитектура

CellAnalyzer следует модульной архитектуре с четким разделением ответственности:

**Основные Компоненты**:

- **MainWindow**: Контроллер приложения и менеджер состояний
- **ImageProcessor**: Движок обработки изображений на базе OpenCV
- **AdvancedDetector**: Система мультиалгоритмной детекции
- **ParameterTuningWidget**: Интерфейс интерактивной оптимизации параметров
- **VerificationWidget**: Ручная проверка и управление клетками
- **StatisticsAnalyzer**: Движок статистических вычислений
- **StatisticsWidget**: Многовкладочная визуализация статистики

**Вспомогательные Системы**:

- **ThemeManager**: Система светлой/темной темы с постоянными настройками
- **SettingsManager**: Сохранение настроек на базе JSON (паттерн Singleton)
- **Logger**: Потокобезопасное логирование с автоматической ротацией
- **ZoomableImageWidget**: Продвинутый просмотрщик изображений с zoom/pan
- **ImprovedPreviewGrid**: Сетка изображений с drag-and-drop и сортировкой

### Алгоритмы Детекции

1. **HoughCircles**: Лучше всего для круглых/циркулярных клеток с четкими границами
2. **ContourBased**: Определяет произвольные формы клеток с использованием анализа контуров
3. **Watershed**: Разделяет перекрывающиеся или соприкасающиеся клетки
4. **Morphological**: Определение по форме с использованием морфологических операций
5. **Adaptive Threshold**: Обрабатывает изменяющийся контраст по изображению
6. **Blob Detection**: Детекция на основе ключевых точек для нерегулярных паттернов

### Возможности Производительности

- Эффективное глубокое копирование cv::Mat
- Ленивая загрузка для предпросмотра изображений
- Ротация файлов логов (по умолчанию 10MB, 5 резервных копий)
- Настраиваемые размеры предпросмотра
- Пакетная обработка с отслеживанием прогресса
- Поддержка Unicode путей

### Управление Данными

- Настройки: `%LOCALAPPDATA%\CellAnalyzer\settings.json`
- Логи: `./logs/cell_analyzer.log`
- Пресеты: Хранятся в настройках с параметрами и коэффициентами
- Предпочтение темы: Автоматически загружается при запуске

## Лицензия

MIT License (или укажите вашу лицензию)

## Вклад в Проект

Приветствуются вклады! Не стесняйтесь отправлять pull request'ы или открывать issue для багов и запросов функций.

### Настройка Разработки

1. Установите Qt6 и OpenCV 4.11.0
2. Настройте CMake с путями к зависимостям
3. Соберите с использованием Visual Studio 2022 или CMake
4. Запустите тесты и проверьте функциональность

### Структура Кода

- `*.h/cpp`: Основные исходные файлы (виджеты, процессоры, анализаторы)
- `build-release.bat`: Скрипт сборки для Windows
- `CLAUDE.md`: Детальная техническая документация для помощи AI
- `todo.md`: План развития и задачи
